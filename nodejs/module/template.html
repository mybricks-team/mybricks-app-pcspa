<!DOCTYPE html>
<html lang="zh-CN" class="no-js">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- <meta name="viewport" content="user-scalable=no,viewport-fit=cover"> -->
    <meta name="referrer" content="no-referrer" />
    <meta http-equiv="Access-Control-Allow-Origin" content="*" />
    <link
      rel="stylesheet"
      href="//lib.baomitu.com/antd/4.21.6/antd.min.css"
    />

    <title>--title--</title>

    <style></style>

    <!-- react about -->
    <script src="//lib.baomitu.com/react/18.0.0/umd/react.production.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/react-dom@18.0.0/umd/react-dom.production.min.js"></script>

    <!-- antd about -->
    <script src="//lib.baomitu.com/moment.js/2.29.4/moment.min.js"></script>
    <script src="//lib.baomitu.com/moment.js/2.29.4/locale/zh-cn.min.js"></script>

    <script src="//lib.baomitu.com/antd/4.21.6/antd.min.js"></script>
    <script src="//f2.eckwai.com/udata/pkg/eshop/fangzhou/pub/pkg/antd-4.21.6/locale/zh_CN.js"></script>
    <script src="//lib.baomitu.com/ant-design-icons/4.7.0/index.umd.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/@ant-design/charts@1.2.14/dist/charts.min.js"></script>
    <script
      crossorigin="anonymous"
      src="//lib.baomitu.com/axios/0.18.1/axios.min.js"
    ></script>
    <script src="//cdn.jsdelivr.net/npm/@mybricks/plugin-connector-http@1.1.35/runtime/index.js"></script>
    <script src="//cdn.jsdelivr.net/npm/@mybricks/plugin-connector-domain@0.0.44/runtime/index.js"></script>

    <!-- mybricks-render-web -->
    <script src="//cdn.jsdelivr.net/npm/@mybricks/render-web@1.1.66/index.min.js"></script>

    <!-- comlib-rt 替换成特定的组件库rt地址 -->
    <!-- <script src="--ComlibRtUrl--"></script> -->

    <!-- comlib-rt -->
  </head>

  <body>
    <div id="qiankun-container"></div>

    <script entry>
      ;((global) => {
        function decode(str) {
          try {
            return decodeURIComponent(str)
          } catch (err) {
            if (process.env.NODE_ENV !== 'production') {
              console.warn(false, `Error decoding "${str}". Leaving it intact.`)
            }
          }
          return str
        }

        function parseQuery(query) {
          const res = {}
          query = query
            .trim()
            .replace(
              new RegExp(decodeURIComponent('%5E(%5C%3F%7C%23%7C%26)')),
              ''
            )
          if (!query) {
            return res
          }
          query.split('&').forEach((param) => {
            const parts = param
              .replace(new RegExp(decodeURIComponent('%5C%2B'), 'g'), ' ')
              .split('=')
            const key = decode(parts.shift())
            const val = parts.length > 0 ? decode(parts.join('=')) : null
            if (res[key] === undefined) {
              res[key] = val
            } else if (Array.isArray(res[key])) {
              res[key].push(val)
            } else {
              res[key] = [res[key], val]
            }
          })
          return res
        }

        const getComs = () => {
          const comDefs = {}
          const regAry = (comAray) => {
            comAray.forEach((comDef) => {
              if (comDef.comAray) {
                regAry(comDef.comAray)
              } else {
                comDefs[`${comDef.namespace}-${comDef.version}`] = comDef
              }
            })
          }
          // Object.keys(window['CloudComponentDependentComponents']).forEach((key) => {
          //   const [namespace, version] = key.split('@');

          //   comDefs[`${namespace}-${version}`] =
          //     window['CloudComponentDependentComponents'][key];
          // });
          const comlibs = [
            ...(window['__comlibs_edit_'] || []),
            ...(window['__comlibs_rt_'] || []),
          ]
          comlibs.forEach((lib) => {
            const comAray = lib.comAray
            if (comAray && Array.isArray(comAray)) {
              regAry(comAray)
            }
          })
          return comDefs
        }

        const React = global.React
        const ReactDom = global.ReactDOM
        const { render: renderUI } = global._mybricks_render_web
        const projectJson = '--projectJson--' //replace it
        const projectId = '--slot-project-id--' //replace it
        const axios = window.axios
        const message = window?.antd.message

        function Page({ props }) {
          return renderUI(projectJson, {
            env: {
              silent: true,
              showErrorNotification: false,
              canvasElement: document.body,
              get vars() {
                // 环境变量
                return {
                  get getQuery() {
                    return () => {
                      return parseQuery(location.search)
                    }
                  },
                  get getProps () { // 获取主应用参数方法，如：token等参数，取决于主应用传入
                    return () => {
                      if (!props) return undefined
                      return props
                    }
                  },
                  get getCookies() {
                    return () => {
                      const cookies = document.cookie
                        .split('; ')
                        .reduce((s, e) => {
                          const p = e.indexOf('=')
                          s[e.slice(0, p)] = e.slice(p + 1)
                          return s
                        }, {})

                      return cookies
                    }
                  },
                  get getRouter() {
                    const isUri = (url) => {
                      return /^http[s]?:\/\/([\w\-\.]+)+[\w-]*([\w\-\.\/\?%&=]+)?$/gi.test(
                        url
                      )
                    }
                    return () => ({
                      reload: () => location.reload(),
                      redirect: ({ url }) => location.replace(url),
                      back: () => history.back(),
                      forward: () => history.forward(),
                      pushState: ({ state, title, url }) => {
                        if (isUri(url)) {
                          //兼容uri
                          location.href = url
                        } else {
                          history.pushState(state, title, url)
                        }
                      },
                      openTab: ({ url, title }) => open(url, title || '_blank'),
                    })
                  },
                }
              },
              projectId,
              /** 调用领域模型 */
              callDomainModel(domainModel, type, params) {
                return pluginConnectorDomain.call(domainModel, params, {
                  action: type,
                  before(options) {
                    if (['domain', 'aggregation-model'].includes(domainModel.type)) {
                      let newOptions = { ...options }
                      if (projectId) {
                        Object.assign(newOptions.data, {
                          projectId: projectId,
                        })
                      }
                      return {
                        ...newOptions,
                        url: domainServicePath,
                      }
                    } else {
                      return options
                    }
                  },
                })
              },
              callConnector(connector, params, privateDomainMap) {
                //调用连接器
                if (connector.type === 'http') {
                  //服务接口类型
                  return pluginConnectorHttp.call(
                    { script: connector.script, params },
                    params
                  )
                } else {
                  return Promise.reject('错误的连接器类型.')
                }
              },
              renderCom(json, opts, coms) {
                return renderUI(json, {
                  comDefs: { ...getComs(), ...coms },
                  // observable: window['rxui'].observable,
                  ...(opts || {}),
                })
              },
              // uploadFile: uploadApi,
            },
          })
        }

        function render(props) {
          ReactDom.render(
            React.createElement(
              antd.ConfigProvider,
              {
                locale: antd.locale['zh_CN'].default,
              },
              React.createElement(Page, { props })
            ),
            document.querySelector('#qiankun-container')
          )
          return Promise.resolve()
        }

        console.log('app load', !!global.__POWERED_BY_QIANKUN__)
        
        if (global.__POWERED_BY_QIANKUN__) {
          global['purehtml'] = {
            bootstrap: () => {
              console.log('purehtml bootstrap')
              return Promise.resolve()
            },
            mount: (props) => {
              console.log('purehtml mount', props)
              return render(props)
            },
            unmount: (props) => {
              const { container } = props
              ReactDOM &&
                ReactDOM.unmountComponentAtNode(
                  (container || document).querySelector('#qiankun-container')
                )
              return Promise.resolve()
            },
          }
        } else {
          render()
        }
      })(window)
    </script>
  </body>
</html>
